name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (format: X.Y.Z)'
        required: true
        type: string

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION (expected: X.Y.Z)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "‚úÖ Version validated: $VERSION"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name lexecon-production

      - name: Verify kubectl connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Send Slack approval request
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üöÄ Production deployment pending approval",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Production Deployment - Approval Required"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ env.VERSION }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction (EKS)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è Review the deployment details and approve in GitHub Actions to proceed."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Approve in GitHub"
                      },
                      "style": "primary",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Create git tag
        run: |
          git config --global user.email "ci@lexecon.io"
          git config --global user.name "Lexecon CI/CD"
          git tag -a "v${{ env.VERSION }}" -m "Production release v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"
          echo "‚úÖ Created and pushed tag v${{ env.VERSION }}"

      - name: Deploy to Kubernetes
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
        run: |
          chmod +x infrastructure/scripts/deploy.sh
          ./infrastructure/scripts/deploy.sh production ${{ env.VERSION }}

      - name: Wait for rollout to complete
        run: |
          kubectl wait --for=condition=available --timeout=10m \
            deployment/lexecon-prod -n production
          echo "‚úÖ Deployment rollout complete"

      - name: Verify deployment health
        run: |
          echo "Checking pod health..."
          kubectl get pods -n production -l app.kubernetes.io/name=lexecon

          POD_NAME=$(kubectl get pods -n production -l app.kubernetes.io/name=lexecon -o jsonpath='{.items[0].metadata.name}')

          echo "Running health checks..."
          kubectl exec -n production $POD_NAME -- curl -sf http://localhost:8000/health/live || exit 1
          echo "‚úÖ Liveness check passed"

          kubectl exec -n production $POD_NAME -- curl -sf http://localhost:8000/health/ready || exit 1
          echo "‚úÖ Readiness check passed"

          kubectl exec -n production $POD_NAME -- curl -sf http://localhost:8000/health || exit 1
          echo "‚úÖ Full health check passed"

      - name: Get deployment info
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment lexecon-prod -n production -o wide
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n production -l app.kubernetes.io/name=lexecon -o wide
          echo ""
          echo "=== Service ==="
          kubectl get service lexecon-prod -n production
          echo ""
          echo "=== HPA Status ==="
          kubectl get hpa -n production 2>/dev/null || echo "No HPA configured"

      - name: Generate deployment summary
        run: |
          echo "# üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Liveness probe" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Readiness probe" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Full health endpoint" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack - Success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "‚úÖ Production deployment successful",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Production Deployed Successfully"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ env.VERSION }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction (EKS)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚úÖ Live & Healthy"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "All health checks passed. Production deployment complete."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Notify Slack - Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "üî¥ Production deployment failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üî¥ Production Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ env.VERSION }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n‚ùå Failed"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Attempted by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.sha }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üö® Production deployment failed. Review logs immediately and consider rollback."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "style": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

      - name: Rollback instructions
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed. To rollback:"
          echo "kubectl rollback deployment/lexecon-prod -n production"
          echo "Or run: ./infrastructure/scripts/rollback.sh production"
